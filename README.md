# Детектор аномальных объемов торгов на Московской Бирже

Скрипт анализирует объемы торгов (обороты в рублях) по акциям на Московской Бирже и выявляет аномально высокие объемы на основе статистического анализа.

## Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Первый запуск - сбор исторических данных

Загрузите данные за последние 60 торговых дней:

```bash
python detector.py --init --days 60
```

### 3. Анализ аномалий

```bash
# Анализ вчерашнего дня (по умолчанию)
python detector.py

# Анализ конкретной даты
python detector.py --date 2026-01-31

# Принудительное обновление данных
python detector.py --date 2026-01-31 --force
```

## Как это работает

### Алгоритм

1. **Базовый период**: Берутся последние 5 торговых дней ДО целевой даты
2. **Статистика**: Для каждой акции вычисляется среднее (μ) и стандартное отклонение (σ) оборота
3. **Сравнение**: Оборот целевой даты сравнивается с базовой статистикой
4. **Аномалия**: Тикер попадает в отчёт если выполняются **оба условия**:
   - Z-score > 3.0σ
   - Отклонение от среднего > 500%

### Фильтрация

Из анализа автоматически исключаются:
- Тикеры с префиксом `RU000` (облигации, ISIN коды)
- Тикеры с "ETF" в названии

### Пример

```
Целевая дата: 31.01.2026
Базовый период: 24-30.01.2026 (5 торговых дней)

Акция ABCD:
  Средний оборот за 5 дней: 10 млн руб
  Стандартное отклонение: 2 млн руб
  Оборот 31.01.2026: 80 млн руб

  Z-score = (80 - 10) / 2 = 35.0
  Отклонение = (80 - 10) / 10 * 100 = 700%

  Z-score 35.0 > 3.0 ✓
  Отклонение 700% > 500% ✓

  → АНОМАЛИЯ!
```

## Структура проекта

```
imoex-anomaly/
├── detector.py              # Основной скрипт анализа
├── notify.py                # Telegram уведомления
├── requirements.txt         # Зависимости Python
├── Dockerfile               # Сборка Docker образа
├── docker-compose.yml       # Конфигурация Docker
├── nginx.conf               # Веб-сервер для отчетов
├── entrypoint.sh            # Скрипт запуска контейнера
├── cron/
│   └── detector-cron        # Расписание автозапуска
├── web/
│   └── generate_index.py    # Генератор HTML страницы
├── data/                    # Кеш данных (создается автоматически)
│   ├── volumes_2026-01-01.json
│   └── ...
└── reports/                 # Отчеты (создается автоматически)
    ├── anomalies_2026-01-31.txt
    ├── anomalies_2026-01-31.json
    └── ...
```

## Параметры запуска

| Команда | Описание |
|---------|----------|
| `--date YYYY-MM-DD` | Дата для анализа (по умолчанию: вчера) |
| `--init` | Режим инициализации (загрузка исторических данных) |
| `--days N` | Количество дней для загрузки в режиме `--init` (по умолчанию: 60) |
| `--force` | Принудительно перезагрузить данные с API |

### Примеры

```bash
# Загрузить данные за последние 90 дней
python detector.py --init --days 90

# Анализ вчерашнего дня
python detector.py

# Анализ 15 января 2026
python detector.py --date 2026-01-15

# Анализ с принудительным обновлением данных
python detector.py --date 2026-01-31 --force

# Справка
python detector.py --help
```

## Настройки

Основные параметры находятся в начале файла `detector.py`:

```python
# Порог аномалии в стандартных отклонениях (σ)
ANOMALY_THRESHOLD_SIGMA = 3.0

# Минимальное отклонение для попадания в отчет (%)
MIN_DEVIATION_PERCENT = 500

# Префиксы тикеров для исключения (облигации, ISIN коды и т.д.)
EXCLUDED_TICKER_PREFIXES = ("RU000",)

# Ключевые слова в названии для исключения (ETF и т.д.)
EXCLUDED_SHORTNAME_KEYWORDS = ("ETF",)

# Параметры повторных попыток при ошибке API
MAX_RETRIES = 5
RETRY_DELAY = 60  # секунд
```

## Форматы отчетов

### TXT отчет

Человекочитаемый формат:

```
======================================================================
АНОМАЛИИ ОБЪЕМОВ ТОРГОВ
Дата анализа: 31.01.2026
Базовый период: 26.01 - 30.01.2026 (5 дней)
Порог аномалии: 3.0σ
======================================================================

Обнаружено аномалий: 2

[1] ABCD - Компания АБВ
    Оборот: 80.0 млн руб
    Средний: 10.0 млн руб
    Z-score: +35.00
    Отклонение: +700.0%

[2] WXYZ - Компания ИКС
    Оборот: 150.0 млн руб
    Средний: 20.0 млн руб
    Z-score: +12.50
    Отклонение: +650.0%
...
```

### JSON отчет

Машиночитаемый формат для автоматизации:

```json
{
  "metadata": {
    "analysis_date": "2026-01-31",
    "base_period_start": "2026-01-26",
    "base_period_end": "2026-01-30",
    "base_period_days": 5,
    "threshold_sigma": 3.0,
    "total_tickers": 250,
    "anomalies_found": 2
  },
  "anomalies": [
    {
      "rank": 1,
      "ticker": "ABCD",
      "shortname": "Компания АБВ",
      "current_value": 80000000,
      "avg_value": 10000000,
      "std_value": 2000000,
      "z_score": 35.0,
      "deviation_percent": 700.0,
      "base_days_count": 5
    }
  ],
  "warnings": []
}
```

## Docker и Coolify

Проект готов к деплою через Docker или Coolify.

### Локальный запуск через Docker

```bash
# Сборка и запуск
docker-compose up --build

# Веб-интерфейс с отчетами
open http://localhost:8080
```

### Деплой в Coolify

1. В Coolify создайте новый проект: **Docker Compose**
2. Укажите репозиторий: `abukreev-dev/imoex-anomaly`
3. Добавьте переменные окружения (опционально):
   ```
   TELEGRAM_BOT_TOKEN=ваш_токен
   TELEGRAM_CHAT_ID=ваш_chat_id
   ```
4. Нажмите Deploy

Подробная инструкция: [DEPLOY.md](DEPLOY.md)

### Возможности Docker-версии

- Веб-интерфейс для просмотра отчетов
- Автозапуск анализа по cron (10:00 MSK, Пн-Пт)
- Telegram уведомления об аномалиях
- Персистентное хранение данных и отчетов

## Telegram уведомления

При обнаружении аномалий скрипт может отправлять уведомления в Telegram.

### Настройка

1. Создайте бота через [@BotFather](https://t.me/BotFather)
2. Получите Chat ID через `https://api.telegram.org/bot<TOKEN>/getUpdates`
3. Установите переменные окружения:
   ```bash
   export TELEGRAM_BOT_TOKEN="ваш_токен"
   export TELEGRAM_CHAT_ID="ваш_chat_id"
   ```

### Ручная отправка

```bash
python notify.py
```

## Особенности работы

### Кеширование данных

- Данные загружаются с API один раз и сохраняются локально
- При повторном запуске используются данные из кеша
- Флаг `--force` принудительно обновляет данные

### Обработка дублей тикеров

Один тикер может торговаться в нескольких режимах (T+2, вечерка, аукцион).
Скрипт **суммирует обороты** по всем режимам для получения полной картины.

### Учет торговых дней

При расчете "5 дней назад" учитываются только **торговые дни** (будни).
Выходные и праздники автоматически пропускаются.

### Обработка ошибок

- **Недостаточно данных**: Если у тикера меньше 5 дней истории, используются имеющиеся данные с предупреждением
- **Ошибка API**: 5 попыток с паузой 60 секунд, затем остановка скрипта
- **Нет торгов за дату**: Выводится информационное сообщение

## Интерпретация результатов

### Z-score

- **3.0 - 4.0σ**: Сильная аномалия (~0.1-0.3% вероятность)
- **4.0 - 5.0σ**: Очень сильная аномалия (<0.01% вероятность)
- **> 5.0σ**: Экстремальная аномалия (практически невозможно случайно)

### Возможные причины аномалий

**Позитивные факторы:**
- Объявление дивидендов
- Позитивные новости/отчеты
- Сделки M&A
- Включение в индекс

**Негативные факторы:**
- Санкции
- Судебные иски
- Плохая отчетность
- Панические продажи

**Технические факторы:**
- Экспирация деривативов
- Ребалансировка фондов
- Технический сбой

## Устранение проблем

### Ошибка: "Could not resolve host: iss.moex.com"

**Причина**: Нет интернет-соединения или блокировка DNS

**Решение**: Проверьте интернет-соединение

### Ошибка: "Не удалось загрузить данные после 5 попыток"

**Причина**: API Мосбиржи недоступен или перегружен

**Решение**:
1. Проверьте доступность https://iss.moex.com
2. Попробуйте позже
3. Увеличьте `RETRY_DELAY` в коде

### Предупреждение: "Тикер XXX: только 2 дней данных вместо 5"

**Причина**: Новая компания или недавнее IPO

**Решение**: Это нормально, статистика будет менее точной

## Лицензия

MIT License - используйте свободно для личных и коммерческих проектов.

## Дисклеймер

Этот инструмент предназначен только для информационных целей.
Не является инвестиционной рекомендацией.
Автор не несет ответственности за торговые решения, принятые на основе данных скрипта.

---

**API**: Московская Биржа (ISS)
**Язык**: Python 3.7+
**Зависимости**: requests
